
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Introduction Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="Docker.html" />
    
    
    <link rel="prev" href="README.md" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../chapter-sentry/">
            
                <a href="../chapter-sentry/">
            
                    
                    Keycloak Sentry integration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../chapter-storage/">
            
                <a href="../chapter-storage/">
            
                    
                    Keycloak Storage
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../chapter-storage/create_database.html">
            
                <a href="../chapter-storage/create_database.html">
            
                    
                    Creating the database structure in Keycloak
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../chapter-storage/cockroachdb.html">
            
                <a href="../chapter-storage/cockroachdb.html">
            
                    
                    CockroachDB
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../chapter-protocol/">
            
                <a href="../chapter-protocol/">
            
                    
                    Keycloak Protocol
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../chapter-protocol/general_principals.html">
            
                <a href="../chapter-protocol/general_principals.html">
            
                    
                    General principals
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../chapter-protocol/ws-fed.html">
            
                <a href="../chapter-protocol/ws-fed.html">
            
                    
                    Implementation of WS-FED
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="README.md">
            
                <span>
            
                    
                    Deployment
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.5.1" data-path="Introduction.html">
            
                <a href="Introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="Docker.html">
            
                <a href="Docker.html">
            
                    
                    Docker
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="Kubernetes.html">
            
                <a href="Kubernetes.html">
            
                    
                    Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="Systemd_In_Kubernetes.html">
            
                <a href="Systemd_In_Kubernetes.html">
            
                    
                    Systemd In Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="Ansible.html">
            
                <a href="Ansible.html">
            
                    
                    Ansible
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../chapter-godevel/">
            
                <a href="../chapter-godevel/">
            
                    
                    Go Development
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../chapter-godevel/structure.html">
            
                <a href="../chapter-godevel/structure.html">
            
                    
                    Repository Structure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../chapter-godevel/test.html">
            
                <a href="../chapter-godevel/test.html">
            
                    
                    Testing with mocks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../chapter-godevel/logging.html">
            
                <a href="../chapter-godevel/logging.html">
            
                    
                    Logging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../chapter-godevel/instrumenting.html">
            
                <a href="../chapter-godevel/instrumenting.html">
            
                    
                    Instrumenting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="../chapter-godevel/tracing.html">
            
                <a href="../chapter-godevel/tracing.html">
            
                    
                    Tracing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="../chapter-godevel/tracking.html">
            
                <a href="../chapter-godevel/tracking.html">
            
                    
                    Tracking
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Introduction</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="kubernetes-general-architecture">Kubernetes general architecture</h1>
<p>Kubernetes is a container orchestrator from google and co. It comes with lots of moving parts and can be overwhelming to understand at first.
Here we explore the important bits that everyone should understand, and how they relate to cloudtrust.</p>
<h2 id="internal-components">Internal components</h2>
<h3 id="kubectl">Kubectl</h3>
<p>kubectl is the client program that connects to kubernetes and sends commands. It&apos;s a glorified wrapper over <code>curl</code> (just use -v9 as an option when running any command and it will show the curl command that will yield the same result).</p>
<h3 id="kubelet">Kubelet</h3>
<p>The kubelet is a daemon running on every node that provides an API able to get information on that node. It&apos;s mostly a bridge for various docker/systems related tasks.
It&apos;s the component in charge of running containers, creating volumes, etc...</p>
<h3 id="api-server">API-Server</h3>
<p>The kube-apiserver can be considered the kubernetes &quot;master&quot;. Like its name suggests, it is in charge on the entire kubernetes api. Every call from the kubectl ends at an apiserver, and every kubernetes-related component is aware of at least one such master. Since kubernetes is meant for distributed workloads, the apiserver can be scaled out. As such, it stores all its data in a distributed KV store (etcd)</p>
<h3 id="scheduler">Scheduler</h3>
<p>The kube-scheduler is in charge of scheduling containers onto nodes. It registers to the apiserver, which will send it specs of containers to run and the general state of the cluster. The scheduler can be distributed too, and does leader election through the apiserver</p>
<h3 id="controller-manager">Controller Manager</h3>
<p>The kube-controller-manager is in charge of all control loops in kubernetes. For instance, changing the number of replicas in a replication controller will cause the kube-controller-manager to update its desired state, and then act on the apiserver to work towards that state. It does leader election through the apiserver.</p>
<h3 id="proxy">Proxy</h3>
<p>The kube-proxy is responsible for all the routing between kubernetes nodes</p>
<h2 id="external-components">External components</h2>
<h3 id="overlay2-filesystem">Overlay2 filesystem</h3>
<p>We use the overlay2 fs as our layered filesystem. We did not do in depth comparison of various storage drivers. This might come later
Overlay2 is very simple and performs well and has been picked for these reasons</p>
<h3 id="docker">Docker</h3>
<p>Docker is our container engine of choice. It is in charge of spawning containers from images. Not much more. It is only accessible locally by talking to its unix socket.</p>
<h3 id="flannel">Flannel</h3>
<p>Containers live in their (shared) network namespace, so they can communicate with one another using their IP addresses and such. Containers across different hosts however, cannot. Flannel is a daemon that provides an overlay network that all containers can share. Internally, it works by setting and maintaining vxlan interfaces accross all nodes. It synchronizes using etcd as a distributed KV store.</p>
<h3 id="etcd">Etcd</h3>
<p>etcd is a distributed KV store used by the kube-apiserver and flannel.</p>
<h2 id="how-it-all-interacts">How it all interacts</h2>
<h3 id="typical-structure-of-a-kubernetes-node">Typical structure of a kubernetes node</h3>
<p>A kubernetes node typically has 3 things going on to connect it to the rest of the Ecosystem. Each node should be thought of as belonging to 3 networks, each maintained differently.</p>
<ul>
<li><p>1: The Flannel IP. Each node joining the cluster is assigned a unique flannel range that is a subrange of the cluster&apos;s range. (ie, if the cluster range is 10.244.0.0/16, a node A&apos;s range could be 10.244.23.0/24, and node B 10.244.52.0/24). Flannel operates by creating a virtual network interface that is used to route traffic to the other nodes using vxlan.
Containers are assigned IPs from the flannel range by the docker daemon, which is made aware of the network by getting parameters from a file generated by flannel on cluster-join. The default bridge ip becomes flannel&apos;s node range.</p>
</li>
<li><p>2: The Cluster IP. Kubernetes cluster can define a cluster IP for kubernetes managed services. Using this mechanism, we can expose a postgresql service on ip 10.254.10.223, which will point to the postgresql containers IPs. This is kept up to date by the kube-proxy, which watches updates to the apiserver and modifies iptables NAT rules accordingly. The cluster IP does not have an interface. Cluster IP backends are NOT currently load-balanced. So if a service links to multiple containers, each kube-proxy will pick a backend in a round-robin fashion and not change it until the container goes down. This provides a very primitive form of load-balancing, but is unsatisfactory.</p>
</li>
<li><p>3: The node&apos;s IP. This is the public IP of the node, and the only real NIC the node should need</p>
</li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="README.md" class="navigation navigation-prev " aria-label="Previous page: Deployment">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="Docker.html" class="navigation navigation-next " aria-label="Next page: Docker">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Introduction","level":"1.5.1","depth":2,"next":{"title":"Docker","level":"1.5.2","depth":2,"path":"chapter-deploy/Docker.md","ref":"chapter-deploy/Docker.md","articles":[]},"previous":{"title":"Deployment","level":"1.5","depth":1,"path":"chapter-deploy/README.md","ref":"chapter-deploy/README.md","articles":[{"title":"Introduction","level":"1.5.1","depth":2,"path":"chapter-deploy/Introduction.md","ref":"chapter-deploy/Introduction.md","articles":[]},{"title":"Docker","level":"1.5.2","depth":2,"path":"chapter-deploy/Docker.md","ref":"chapter-deploy/Docker.md","articles":[]},{"title":"Kubernetes","level":"1.5.3","depth":2,"path":"chapter-deploy/Kubernetes.md","ref":"chapter-deploy/Kubernetes.md","articles":[]},{"title":"Systemd In Kubernetes","level":"1.5.4","depth":2,"path":"chapter-deploy/Systemd_In_Kubernetes.md","ref":"chapter-deploy/Systemd_In_Kubernetes.md","articles":[]},{"title":"Ansible","level":"1.5.5","depth":2,"path":"chapter-deploy/Ansible.md","ref":"chapter-deploy/Ansible.md","articles":[]}]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"chapter-deploy/Introduction.md","mtime":"2018-02-01T14:49:32.561Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-02-23T07:19:13.617Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

