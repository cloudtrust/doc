
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Systemd In Kubernetes Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-richquotes/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="Ansible.html" />
    
    
    <link rel="prev" href="Kubernetes.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Keycloak Development
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../chapter-keycloak/sentry.html">
            
                <a href="../chapter-keycloak/sentry.html">
            
                    
                    Sentry integration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../chapter-keycloak/storage.html">
            
                <a href="../chapter-keycloak/storage.html">
            
                    
                    Storage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../chapter-keycloak/protocol.html">
            
                <a href="../chapter-keycloak/protocol.html">
            
                    
                    Protocol
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="2.1" >
            
                <span>
            
                    
                    Deployment
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="Introduction.html">
            
                <a href="Introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2" data-path="Docker.html">
            
                <a href="Docker.html">
            
                    
                    Docker
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.3" data-path="Kubernetes.html">
            
                <a href="Kubernetes.html">
            
                    
                    Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.1.4" data-path="Systemd_In_Kubernetes.html">
            
                <a href="Systemd_In_Kubernetes.html">
            
                    
                    Systemd In Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.5" data-path="Ansible.html">
            
                <a href="Ansible.html">
            
                    
                    Ansible
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.6" data-path="Configs.html">
            
                <a href="Configs.html">
            
                    
                    Configurations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.7" data-path="Telepresence.html">
            
                <a href="Telepresence.html">
            
                    
                    Telepresence
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.8" data-path="Deployment_Procedure_Cluster.html">
            
                <a href="Deployment_Procedure_Cluster.html">
            
                    
                    Deployment procedure
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="3.1" >
            
                <span>
            
                    
                    Go Development
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="../chapter-godevel/guideline.html">
            
                <a href="../chapter-godevel/guideline.html">
            
                    
                    Guidelines
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="../chapter-godevel/structure.html">
            
                <a href="../chapter-godevel/structure.html">
            
                    
                    Repository Structure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="../chapter-godevel/testing.html">
            
                <a href="../chapter-godevel/testing.html">
            
                    
                    Testing with mocks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="../chapter-godevel/logging.html">
            
                <a href="../chapter-godevel/logging.html">
            
                    
                    Logging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.5" data-path="../chapter-godevel/instrumenting.html">
            
                <a href="../chapter-godevel/instrumenting.html">
            
                    
                    Instrumenting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6" data-path="../chapter-godevel/tracing.html">
            
                <a href="../chapter-godevel/tracing.html">
            
                    
                    Tracing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7" data-path="../chapter-godevel/tracking.html">
            
                <a href="../chapter-godevel/tracking.html">
            
                    
                    Tracking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8" data-path="../chapter-godevel/health_route.html">
            
                <a href="../chapter-godevel/health_route.html">
            
                    
                    Health routes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.9" data-path="../chapter-godevel/debugging.html">
            
                <a href="../chapter-godevel/debugging.html">
            
                    
                    Debugging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.10" data-path="../chapter-godevel/middleware.html">
            
                <a href="../chapter-godevel/middleware.html">
            
                    
                    Middlewares
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Systemd In Kubernetes</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="systemd-containers-on-kubernetes">Systemd Containers on Kubernetes.</h1>
<h2 id="the-pause-container-is-pid-1">The Pause container is PID 1</h2>
<p>This has already been described in another section.
If PID namespace sharing is enabled (it is by default), the pause process will get PID 1, and systemd will not start up. This is solved by giving the <code>--disable-docker-shared-pid</code> flag to the kubelet.</p>
<h2 id="failed-to-change-ownership-of-session-keyring-permission-denied">Failed to change ownership of session keyring: Permission denied</h2>
<p>This is an issue that plagued us for a long time so I&apos;m going to go in depth into what it is and why it happened.</p>
<p>Containers are different from VMs in that they run on the same kernel, and that is a limitation of the design (if they didn&apos;t they would be VMs, there&apos;s no way around it). As such, certain constructs that are kernel wide will be shared across containers. For instance the whole <code>/sys</code> filesystem, kernel modules, and in particular: kernel keyrings.</p>
<p>Kernel keyrings are a place to store user session secrets, like passwords etc... One component that actively makes use of the kernel keyrings is systemd. However, systemd in a container and systemd outside a container are two wildly different beasts. Systemd in a container is typically limited, especially if it isn&apos;t a privileged container. As such, any attempt to modify the keyring will be met with a &quot;permission denied&quot; error. So systemd attempting to touch keyrings will fail everytime and break the container...
Well we know that&apos;s not true since we are able to run systemd in docker containers, so why can&apos;t we do the same with kubernetes containers? It&apos;s not like our docker containers were more privileged, in fact, they&apos;re even less privileged as they have seccomp rules active.</p>
<p>And that is the main/only difference! Depending on what mechanism blocks the <code>keyctl</code> call, selinux, capabilities, seccomp, the return code of the syscall will be different. With SELinux and Capabilities, it&apos;s a rightful <code>ENOPERM</code> which means that systemd is not privileged enough to use keyrings. Systemd expects to be PID 1 and therefore the most root a root process could be, and therefore fails. However, when it is blocked by seccomp, it returns <code>ENOSYS</code> which could mean that the current kernel has no support for kernel keyrings. Well systemd is happy to oblige and will keep secrets somewhere else, since keyrings aren&apos;t supported on this kernel.</p>
<p>Now the big issue with kubernetes at first glance is that seccomp doesn&apos;t appear to be supported ( <a href="https://github.com/kubernetes/kubernetes/issues/20870" target="_blank">https://github.com/kubernetes/kubernetes/issues/20870</a> ), but digging in the source code we quickly find the file <code>pkg/security/podsecuritypolicy/seccomp/strategy.go</code> which shows us that it is indeed supported. From there we can get <code>staging/src/k8s.io/api/core/v1/annotation_key_constants.go</code> which shows us that there is a tag <code>seccomp.security.alpha.kubernetes.io/pod</code> that can be applied on a pod to give it a seccomp profile, and finally we can get that <code>v1.SeccompPodAnnotationKey: &quot;docker/default&quot;</code> returns the default docker seccomp profile, which confines <code>keyctl</code> appropriately.</p>
<p>sources : </p>
<ul>
<li><a href="https://github.com/systemd/systemd/issues/7655" target="_blank">https://github.com/systemd/systemd/issues/7655</a></li>
<li><a href="https://github.com/systemd/systemd/issues/6281" target="_blank">https://github.com/systemd/systemd/issues/6281</a></li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="Kubernetes.html" class="navigation navigation-prev " aria-label="Previous page: Kubernetes">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="Ansible.html" class="navigation navigation-next " aria-label="Next page: Ansible">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Systemd In Kubernetes","level":"2.1.4","depth":2,"next":{"title":"Ansible","level":"2.1.5","depth":2,"path":"chapter-deploy/Ansible.md","ref":"chapter-deploy/Ansible.md","articles":[]},"previous":{"title":"Kubernetes","level":"2.1.3","depth":2,"path":"chapter-deploy/Kubernetes.md","ref":"chapter-deploy/Kubernetes.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["richquotes"],"pluginsConfig":{"richquotes":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"chapter-deploy/Systemd_In_Kubernetes.md","mtime":"2018-08-15T09:24:57.162Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-09-14T09:45:48.517Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

