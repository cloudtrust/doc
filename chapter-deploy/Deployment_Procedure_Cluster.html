
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Deployment procedure Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-richquotes/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="Telepresence.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Keycloak Development
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../chapter-keycloak/sentry.html">
            
                <a href="../chapter-keycloak/sentry.html">
            
                    
                    Sentry integration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../chapter-keycloak/storage.html">
            
                <a href="../chapter-keycloak/storage.html">
            
                    
                    Storage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../chapter-keycloak/protocol.html">
            
                <a href="../chapter-keycloak/protocol.html">
            
                    
                    Protocol
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="2.1" >
            
                <span>
            
                    
                    Deployment
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="Introduction.html">
            
                <a href="Introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2" data-path="Docker.html">
            
                <a href="Docker.html">
            
                    
                    Docker
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.3" data-path="Kubernetes.html">
            
                <a href="Kubernetes.html">
            
                    
                    Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.4" data-path="Systemd_In_Kubernetes.html">
            
                <a href="Systemd_In_Kubernetes.html">
            
                    
                    Systemd In Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.5" data-path="Ansible.html">
            
                <a href="Ansible.html">
            
                    
                    Ansible
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.6" data-path="Configs.html">
            
                <a href="Configs.html">
            
                    
                    Configurations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.7" data-path="Telepresence.html">
            
                <a href="Telepresence.html">
            
                    
                    Telepresence
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.1.8" data-path="Deployment_Procedure_Cluster.html">
            
                <a href="Deployment_Procedure_Cluster.html">
            
                    
                    Deployment procedure
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="3.1" >
            
                <span>
            
                    
                    Go Development
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="../chapter-godevel/guideline.html">
            
                <a href="../chapter-godevel/guideline.html">
            
                    
                    Guidelines
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="../chapter-godevel/structure.html">
            
                <a href="../chapter-godevel/structure.html">
            
                    
                    Repository Structure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="../chapter-godevel/testing.html">
            
                <a href="../chapter-godevel/testing.html">
            
                    
                    Testing with mocks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="../chapter-godevel/logging.html">
            
                <a href="../chapter-godevel/logging.html">
            
                    
                    Logging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.5" data-path="../chapter-godevel/instrumenting.html">
            
                <a href="../chapter-godevel/instrumenting.html">
            
                    
                    Instrumenting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6" data-path="../chapter-godevel/tracing.html">
            
                <a href="../chapter-godevel/tracing.html">
            
                    
                    Tracing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7" data-path="../chapter-godevel/tracking.html">
            
                <a href="../chapter-godevel/tracking.html">
            
                    
                    Tracking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8" data-path="../chapter-godevel/health_route.html">
            
                <a href="../chapter-godevel/health_route.html">
            
                    
                    Health routes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.9" data-path="../chapter-godevel/debugging.html">
            
                <a href="../chapter-godevel/debugging.html">
            
                    
                    Debugging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.10" data-path="../chapter-godevel/middleware.html">
            
                <a href="../chapter-godevel/middleware.html">
            
                    
                    Middlewares
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Deployment procedure</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="deployment-guide">Deployment guide</h1>
<p>This document explains how to deploy the CloudTrust components on a cluster.</p>
<p>Disclaimer: The whole deployment procedure was written by a single engineer new to this whole ecosystem, using many different conflicting open-source resources as inspiration.<br>This was done on a best-effort basis, but lacks any sort of rigorous review by an experienced engineer.
As such, it is best to view this work with a critical eye, and try to improve upon it, even refactoring it deeply, if it is judged adequate.</p>
<h3 id="minimal-hardware-requirements">Minimal hardware requirements</h3>
<ul>
<li>CPU: 4 vCPU</li>
<li>RAM: 16 GiB</li>
<li>Disk: 100 GiB</li>
</ul>
<p>These requirements are for a deployment of the Cloudtrust solution with all the components.
If you do not deploy all the components, you may be able to reduce the requirements.</p>
<p>One cluster requires at least 3 VMs running Fedora.</p>
<h3 id="software-versions">Software versions</h3>
<p>The policy of the Cloudtrust project concerning versions of software components is to always target the latest stable releases.</p>
<p>In August 2018, we are currently using:</p>
<ul>
<li>Fedora 28</li>
<li>Ansible 2.6.2</li>
<li>Flannel 0.9.0</li>
<li>Docker 1.13.1</li>
<li>Kubernetes 1.10.1</li>
<li>Ceph 12.2.7</li>
<li>PostgreSQL 9.6.9</li>
<li>Elasticsearch 1.7.1</li>
<li>Logstash 6.3.2</li>
<li>InfluxDB 1.6.1</li>
<li>Redis 4.0.10</li>
<li>Kibana 6.3.2</li>
<li>Jaeger</li>
<li>Flaki</li>
<li>Sentry 8.21.0</li>
<li>Keycloak 3.4.3</li>
<li>Grafana 5.2.2</li>
</ul>
<p>Note that versions will most likely change in the future.
The versions indicated here are just an indication.</p>
<h3 id="prerequisites">Prerequisites</h3>
<p>The cluster nodes must run the latest stable version of Fedora.
This deployment procedure also assumes that you have a machine running Fedora.</p>
<p>Install the <code>Container Management</code> environment on your own machine:</p>
<pre><code>dnf install @&apos;Container Management&apos;
</code></pre><h2 id="installation">Installation</h2>
<p>We will use 2 Git repositories:</p>
<ul>
<li>The <code>runtime</code> repository contains generic Ansible scripts.
This repository is hosted on GitHub, at <a href="https://github.com/cloudtrust/runtime" target="_blank">https://github.com/cloudtrust/runtime</a></li>
<li>Another repository contains the configuration files, secrets and certificates required to install the Cloudtrust components on the cluster nodes.
The reference repository is the <code>dev-config</code> repository, hosted at <a href="https://github.com/cloudtrust/dev-config" target="_blank">https://github.com/cloudtrust/dev-config</a>.
You must create a new repository with your own configuration based on this reference repository.</li>
</ul>
<h3 id="configuration">Configuration</h3>
<p>In this first part, we will set all the parameters that are specific to each environment.
To do so, we will work in the repository containing the configuration parameters for the cluster nodes.</p>
<p>Clone the repository:</p>
<pre><code>git clone &lt;repo-url&gt;
</code></pre><p>In the file <code>deployable/inventories/main.ini</code>, specify the IP addresses of your VMs, such as:</p>
<pre><code>[kube-master]
&lt;ip1&gt;
&lt;ip2&gt;

[etcd:children]
kube-master

[kube-slave]
&lt;ip1&gt;
&lt;ip2&gt;
</code></pre><p>If your machines have more than one network interface, you must specify the interface that Kubernetes should bind to in the file <code>deployable/group_vars/all.yml</code>.
In the following example, we use <code>ens4</code>, which is the interface connected to our private network :</p>
<pre><code>[root@admin]# cat group_vars/all.yml
---
default_interface: &quot;&quot;
interface: &quot;ens4&quot;
...
</code></pre><p>In the directory <code>deployable/roles/baseimage/keys/</code>, there are two files <code>id_ssh</code> and <code>id_ssh.pub</code>.
You need to specify an SSH key which gives access to a Github account.
This will be used to clone the cloudtrust repositories when building docker images.<br>Note that for ELCA&apos;s deployments, we already have a service account setup in Github.
You can retrieve this key like so:</p>
<pre><code>git clone ssh://git@git.elcanet.local:7999/cloudtrust/devel-doc.git
cd devel-doc/components/keys/
gpg -d id_ssh.gpg &gt; id_ssh
# The password for decrypting this file is in the Keepass file
# Then, copy the files `id_ssh` and `id_ssh.pub` into `&lt;config-repo&gt;/deployable/roles/baseimage/keys/`.
</code></pre><p>For the following steps, it is required to have a CA certificate to sign the certificates of each components.
If you do not already have one, you can generate your own self-signed CA certificate using OpenSSL.<br>Note that for ELCA&apos;s deployments, we already have a PKI infrastructure in the repository <code>pki-config</code>.</p>
<ul>
<li><p>Ceph:
Secret keys are located in <code>deployable/roles/ceph/files/</code>.
If you need to generate new keys, you can use the following commands:</p>
<pre><code># Make sure you have the Ceph tools installed. They can be installed with `dnf install ceph`.
ceph-authtool --gen-print-key &gt; deployable/roles/ceph/files/admin.key
ceph-authtool --gen-print-key &gt; deployable/roles/ceph/files/bootstrap.key
ceph-authtool --gen-print-key &gt; deployable/roles/ceph/files/mon.key
ceph-authtool --gen-print-key &gt; deployable/roles/ceph/files/user.key
</code></pre><p>Alternatively, you can have the ansible playbooks generate new keys during each deployment by setting <code>dynamic_keys: True</code> in the file <code>deployable/roles/ceph/vars/main.yml</code>.</p>
</li>
<li><p>etcd:
Certificates are located in <code>deployable/roles/etcd-host/files/</code>.
If you need to generate new certificates, you can use the <code>gen_certs.sh</code> script.
You may need to adapt the <code>*.conf</code> files depending on your environment.</p>
<pre><code>cd deployable/roles/etcd-host/files/
PKI_PATH=&quot;&lt;path to the directory containing the ca.crt file&gt;&quot; ./gen_certs.sh
</code></pre></li>
<li><p>Grafana:
Certificates are located in <code>deployable/roles/grafana/files/</code>.
If you need to generate new certificates, you can use the <code>gen_certs.sh</code> script.
You may need to adapt the <code>*.conf</code> files depending on your environment.</p>
<pre><code>cd deployable/roles/grafana/files/
PKI_PATH=&quot;&lt;path to the directory containing the ca.crt file&gt;&quot; ./gen_certs.sh
</code></pre></li>
<li><p>IDP test client:
Certificates are located in <code>deployable/roles/idp-test-client/files/</code>.
If you need to generate new certificates, you can use the <code>gen_certs.sh</code> script.
You may need to adapt the <code>*.conf</code> files depending on your environment.</p>
<pre><code>cd deployable/roles/idp-test-client/files/
PKI_PATH=&quot;&lt;path to the directory containing the ca.crt file&gt;&quot; ./gen_certs.sh
</code></pre></li>
<li><p>Jaeger:
Certificates are located in <code>deployable/roles/jaeger-query/files/</code>.
If you need to generate new certificates, you can use the <code>gen_certs.sh</code> script.
You may need to adapt the <code>*.conf</code> files depending on your environment.</p>
<pre><code>cd deployable/roles/jaeger-query/files/
PKI_PATH=&quot;&lt;path to the directory containing the ca.crt file&gt;&quot; ./gen_certs.sh
</code></pre></li>
<li><p>Keycloak:
Certificates are located in <code>deployable/roles/keycloak/files/</code>.
If you need to generate new certificates, you can use the <code>gen_certs.sh</code> script.
You may need to adapt the <code>*.conf</code> files depending on your environment.</p>
<pre><code>cd deployable/roles/keycloak/files/
PKI_PATH=&quot;&lt;path to the directory containing the ca.crt file&gt;&quot; ./gen_certs.sh
</code></pre></li>
<li><p>Kibana:
Certificates are located in <code>deployable/roles/kibana/files/</code>.
If you need to generate new certificates, you can use the <code>gen_certs.sh</code> script.
You may need to adapt the <code>*.conf</code> files depending on your environment.</p>
<pre><code>cd deployable/roles/kibana/files/
PKI_PATH=&quot;&lt;path to the directory containing the ca.crt file&gt;&quot; ./gen_certs.sh
</code></pre></li>
<li><p>Kubernetes:
Certificates are located in <code>deployable/roles/kubernetes/files/certs/</code>.
If you need to generate new certificates, you can use the <code>gen_certs.sh</code> script.
You may need to adapt the <code>*.conf</code> files depending on your environment.</p>
<pre><code>cd deployable/roles/kubernetes/files/certs/
PKI_PATH=&quot;&lt;path to the directory containing the ca.crt file&gt;&quot; ./gen_certs.sh
</code></pre><p>You can generate a new certificate for the service-account used by Kubernetes:</p>
<pre><code>cd deployable/roles/kubernetes/files/
openssl genrsa -out service-account-key-file.key 4096
</code></pre><p>You can generate a new uuid and place it in <code>deployable/roles/kubernetes/files/tokens</code>:</p>
<pre><code>uuidgen
</code></pre><p>You must also specify the IP of the DNS of your infrastructure in <code>deployable/roles/kubernetes/vars/main.yml</code>:</p>
<pre><code>upstream_dns: [&quot;192.168.1.1&quot;]
</code></pre></li>
<li><p>Sentry:
Certificates are located in <code>deployable/roles/sentry/files/</code>.
If you need to generate new certificates, you can use the <code>gen_certs.sh</code> script.
You may need to adapt the <code>*.conf</code> files depending on your environment.</p>
<pre><code>cd deployable/roles/sentry/files/
PKI_PATH=&quot;&lt;path to the directory containing the ca.crt file&gt;&quot; ./gen_certs.sh
</code></pre></li>
<li><p>Unbound:
To correctly resolve domain names inside the cluster, we run an Unbound instance on every cluster node.
Adapt the configuration in the file <code>deployable/roles/resolver/vars/main.yml</code> with the IP of your DNS server and your domain name:</p>
<pre><code>local_dns: 192.168.1.1
domain: cloudtrust.io
</code></pre></li>
</ul>
<p>Once you are done configuring, commit and push your modifications to the config repository.</p>
<h3 id="deployment">Deployment</h3>
<p>In this part, we will deploy the components that compose the CloudTrust solution on the cluster VMs.</p>
<p>Infrastructure components:</p>
<ul>
<li>Kubernetes</li>
<li>Ceph</li>
</ul>
<p>Business components:</p>
<ul>
<li>PostgreSQL</li>
<li>Elasticsearch</li>
<li>Logstash</li>
<li>InfluxDB</li>
<li>Redis</li>
<li>Kibana</li>
<li>Jaeger</li>
<li>Flaki</li>
<li>Sentry</li>
<li>Keycloak</li>
<li>Grafana</li>
</ul>
<p>The mandatory business components are PostgreSQL and Keycloak.</p>
<p>Clone the <code>runtime</code> repository:</p>
<pre><code>git clone https://github.com/cloudtrust/runtime.git
cd runtime
</code></pre><p>Install the required components in a python virtual environment called <code>venv</code>:</p>
<pre><code>dnf install libselinux-python python2-virtualenv
virtualenv-2 --system-site-packages venv
. venv/bin/activate
pip install -r requirements.txt
</code></pre><p>Create a file <code>&lt;env&gt;-cluster-vars.yml</code> referencing the configuration repository used in the previous section.
It must contain the following entries:</p>
<pre><code>config_repo: &lt;config-repo-url&gt;
# config_repo_name is a name used locally
config_repo_name: dev
config_git_tag: master
</code></pre><p>Configure the project.
This step initializes the <code>runtime</code> project with the settings defined in the configuration repository.</p>
<pre><code>ansible-playbook config.yml --extra-vars &quot;vars_file=&lt;env&gt;-cluster-vars.yml&quot; -t deploy
</code></pre><p>Copy your ssh key to each node:</p>
<pre><code>ssh-copy-id root@&lt;node-ip&gt;
</code></pre><p>Run the resolver playbook.
This ensures that the network configuration will be correctly set on each node.</p>
<pre><code>ansible-playbook resolver.yml -i inventories/main.ini
</code></pre><p>The following Ansible module is required by some of the playbooks. It must be installed under <code>runtime/library/</code>:</p>
<pre><code>mkdir library
curl https://raw.githubusercontent.com/jparrill/ansible-module-etcd/master/library/etcd.py &gt; library/etcd.py
</code></pre><p>Deploy Kubernetes:</p>
<pre><code>ansible-playbook kubernetes.yml -i inventories/main.ini
</code></pre><p>At this point, you can perform a few quick tests by logging on one of the node:</p>
<pre><code>[root@admin]# ssh root@dev-02

# Every pod should be in the &quot;Running&quot; status
[root@dev-02 ~]# kubectl get pods --all-namespaces
NAMESPACE       NAME                                           READY     STATUS    RESTARTS   AGE
default         kube-apiserver-dev-01.cloudtrust.io            1/1       Running   0          14m
default         kube-apiserver-dev-02.cloudtrust.io            1/1       Running   0          14m
default         kube-apiserver-dev-03.cloudtrust.io            1/1       Running   0          14m
default         kube-controller-manager-dev-01.cloudtrust.io   1/1       Running   3          1d
default         kube-controller-manager-dev-02.cloudtrust.io   1/1       Running   3          1d
default         kube-controller-manager-dev-03.cloudtrust.io   1/1       Running   2          1d
default         kube-scheduler-dev-01.cloudtrust.io            1/1       Running   5          1d
default         kube-scheduler-dev-02.cloudtrust.io            1/1       Running   3          1d
default         kube-scheduler-dev-03.cloudtrust.io            1/1       Running   2          1d
ingress-nginx   default-http-backend-5c6d95c48-bl7jz           1/1       Running   2          1d
ingress-nginx   nginx-ingress-controller-5w7jd                 1/1       Running   252        1d
ingress-nginx   nginx-ingress-controller-gmb49                 1/1       Running   554        1d
ingress-nginx   nginx-ingress-controller-jd59m                 1/1       Running   531        1d
kube-addons     kube-dns-6467895fbd-xp44g                      3/3       Running   0          8m

# The IP addresses for the endpoints should be the internal IPs of the nodes
[root@dev-02 ~]# kubectl get endpoints kubernetes
NAME         ENDPOINTS                                               AGE
kubernetes   192.168.1.11:8443,192.168.1.12:8443,192.168.1.13:8443   1d

# Verify that Flannel is binded to the correct network interface
[root@dev-02 ~]# cat /etc/sysconfig/flanneld
...
FLANNELD_IFACE=&quot;ens4&quot;
...
[root@dev-02 ~]# ifconfig
...
ens4: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 192.168.1.12  netmask 255.255.255.0  broadcast 192.168.1.255
...
</code></pre><p>Before deploying Ceph, the docker image <code>cloudtrust-baseimage</code> must be built.
This may take a few minutes, due to running <code>dnf update &amp;&amp; dnf install ...</code> in the image.
You will need to specify the path to the python virtual environment in the ansible variable <code>ansible_python_interpreter</code>, such as:</p>
<pre><code>ansible-playbook baseimage.yml -i inventories/local.ini -e &quot;ansible_python_interpreter=/home/laurent/Desktop/CloudTrust/runtime/venv/bin/python&quot;
</code></pre><p>If everything succeeds, you should see a result like this when you list docker images:</p>
<pre><code>[root@admin]# docker images
REPOSITORY             TAG                 IMAGE ID            CREATED             SIZE
cloudtrust-baseimage   f27                 7f8cc043849e        37 seconds ago      528 MB
docker.io/fedora       27                  9110ae7f579f        5 months ago        235 MB
</code></pre><p>Now that we have the baseimage, deploy Ceph.
It may take a few more minutes to complete:</p>
<pre><code>ansible-playbook ceph.yml -i inventories/main.ini
</code></pre><p><strong> TODO [LVA] </strong> Describe how to verify that Ceph is running</p>
<p>Deploy PostgreSQL:</p>
<pre><code>ansible-playbook postgresql.yml -i inventories/main.ini
</code></pre><p>The first time you deploy, the database is not initialized.
To initialize it, you must enter the container and perform some configuration changes:</p>
<pre><code>ssh root@&lt;node-ip&gt;
kubectl exec -it postgresql-0 /bin/bash
# Change the user and group
chown postgres:postgres /var/lib/pgsql/data/
initdb --pwfile /var/lib/pgsql/postgres.pwd /var/lib/pgsql/data/
</code></pre><p>Edit the file <code>/var/lib/pgsql/data/pg_hba.conf</code>, near the bottom of the file, search for the line:</p>
<pre><code>host    all             all             127.0.0.1/32               trust
</code></pre><p>Replace the line by:</p>
<pre><code>host    all             all             0.0.0.0/0               password
</code></pre><p>Edit the file <code>/var/lib/pgsql/data/postgresql.conf</code>, search for the line:</p>
<pre><code>#listen_addresses = &apos;localhost&apos;
</code></pre><p>Replace the line by:</p>
<pre><code>listen_addresses = &apos;*&apos;
</code></pre><p>Exit the container and restart the pod:</p>
<pre><code>kubectl delete pod postgresql-0
</code></pre><p>Once the pod has restarted, you can check that postgres is running by connecting to the DB:</p>
<pre><code># You can install psql by running `dnf install postresql`
psql -h postgresql -U postgres
</code></pre><p>Deploy Elasticsearch:</p>
<pre><code>ansible-playbook elasticsearch.yml -i inventories/main.ini
</code></pre><p>Deploy Logstash:</p>
<pre><code>ansible-playbook logstash.yml -i inventories/main.ini
</code></pre><p>Deploy Influx:</p>
<pre><code>ansible-playbook influx.yml -i inventories/main.ini
</code></pre><p>Deploy Redis:</p>
<pre><code>ansible-playbook redis.yml -i inventories/main.ini
</code></pre><p>Deploy kibana:</p>
<pre><code>ansible-playbook kibana.yml -i inventories/main.ini
</code></pre><p>Deploy jaeger:</p>
<pre><code>ansible-playbook jaeger.yml -i inventories/main.ini
</code></pre><p>Deploy flaki:</p>
<pre><code>ansible-playbook flaki.yml -i inventories/main.ini
</code></pre><p>Deploy sentry:</p>
<pre><code>ansible-playbook sentry.yml -i inventories/main.ini
</code></pre><p>Deploy keycloak:</p>
<pre><code>ansible-playbook keycloak.yml -i inventories/main.ini
</code></pre><p>Deploy grafana:</p>
<pre><code>ansible-playbook grafana.yml -i inventories/main.ini
</code></pre><h3 id="tests">Tests</h3>
<p>Most of the components can be automatically tested with Python scripts.
The tests scripts for a component are available in the repository named <code>&lt;component&gt;-tools</code>.
The tests are usually divided into the following independent parts:</p>
<ol>
<li><code>test_&lt;component&gt;_container.py</code>: This script unit tests the components and tools installed in a container.
For example, it verifies if systemd is running monit, if each agent is automatically restarted after it is stopped, if there are errors in the logs or if the status of the container is <code>Running</code>.</li>
<li><code>test_&lt;component&gt;_service.py</code>: This script serves as an integration test of the component.
It tests business features, like if it is possible to create a table in a database or if it can insert new data into it.</li>
</ol>
<p>Additionaly, the tools repository of Flaki and Keycloak also contain functionality tests.
These scripts validates that multiple components are correctly connected together. For example, it may test that an action performed in Flaki is recorded within Influx, Cassandra and Jaeger.</p>
<p>Finally, the <code>acceptance-tool</code> repository contains business tests for the Cloudtrust solution.</p>
<h3 id="troubleshooting">Troubleshooting</h3>
<ul>
<li><p>When building docker images, you may encounter an error with <code>rpmdb</code>, like this:</p>
<pre><code>error: rpmdb: BDB0689 Packages page 1399 is on free list with type 7
error: rpmdb: BDB0061 PANIC: Invalid argument
error: db5 error(-30973) from dbcursor-&gt;c_put: BDB0087 DB_RUNRECOVERY: Fatal error, run database recovery
error: error(-30973) adding header #326 record
</code></pre><p>Unfortunately, this error happens intermittently, so it has not been possible to fix it.
The following workaround should allow you to build the image:</p>
<ol>
<li><p>Find the role corresponding to the image and comment the part where the Git repository is cloned.
For example, in <code>roles/logstash/tasks/build.yml</code>:</p>
<pre><code>---
#- name: Pull repository
#  git:
#    repo: &apos;&apos;
#    dest: &apos;&apos;
#    version: &apos;&apos;

- name: Create build context
  file:
    path: &apos;&apos;
    state: directory
...
</code></pre></li>
<li><p>Find the dockerfile and add <code>touch /var/lib/rpm/*</code> at the start of the line which runs <code>dnf</code>.
For example, in <code>pull/logstash/dockerfiles/cloudtrust-logstash.dockerfile</code>:</p>
<pre><code>FROM cloudtrust-baseimage:f27
...
RUN touch /var/lib/rpm/* &amp;&amp; dnf update -y &amp;&amp; \
dnf install -y java java-1.8.0-openjdk.x86_64 logstash &amp;&amp; \
dnf clean all
...
</code></pre></li>
<li><p>Re-execute the ansible playbook.</p>
</li>
</ol>
</li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="Telepresence.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: Telepresence">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Deployment procedure","level":"2.1.8","depth":2,"next":{"title":"Go Development","level":"3.1","depth":1,"ref":"","articles":[{"title":"Guidelines","level":"3.1.1","depth":2,"path":"chapter-godevel/guideline.md","ref":"chapter-godevel/guideline.md","articles":[]},{"title":"Repository Structure","level":"3.1.2","depth":2,"path":"chapter-godevel/structure.md","ref":"chapter-godevel/structure.md","articles":[]},{"title":"Testing with mocks","level":"3.1.3","depth":2,"path":"chapter-godevel/testing.md","ref":"chapter-godevel/testing.md","articles":[]},{"title":"Logging","level":"3.1.4","depth":2,"path":"chapter-godevel/logging.md","ref":"chapter-godevel/logging.md","articles":[]},{"title":"Instrumenting","level":"3.1.5","depth":2,"path":"chapter-godevel/instrumenting.md","ref":"chapter-godevel/instrumenting.md","articles":[]},{"title":"Tracing","level":"3.1.6","depth":2,"path":"chapter-godevel/tracing.md","ref":"chapter-godevel/tracing.md","articles":[]},{"title":"Tracking","level":"3.1.7","depth":2,"path":"chapter-godevel/tracking.md","ref":"chapter-godevel/tracking.md","articles":[]},{"title":"Health routes","level":"3.1.8","depth":2,"path":"chapter-godevel/health_route.md","ref":"chapter-godevel/health_route.md","articles":[]},{"title":"Debugging","level":"3.1.9","depth":2,"path":"chapter-godevel/debugging.md","ref":"chapter-godevel/debugging.md","articles":[]},{"title":"Middlewares","level":"3.1.10","depth":2,"path":"chapter-godevel/middleware.md","ref":"chapter-godevel/middleware.md","articles":[]}]},"previous":{"title":"Telepresence","level":"2.1.7","depth":2,"path":"chapter-deploy/Telepresence.md","ref":"chapter-deploy/Telepresence.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["richquotes"],"pluginsConfig":{"richquotes":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"chapter-deploy/Deployment_Procedure_Cluster.md","mtime":"2018-08-22T10:19:56.571Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-08-22T10:22:37.622Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

