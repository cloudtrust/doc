
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Middlewares Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-richquotes/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="debugging.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Keycloak Development
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../chapter-keycloak/sentry.html">
            
                <a href="../chapter-keycloak/sentry.html">
            
                    
                    Sentry integration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../chapter-keycloak/storage.html">
            
                <a href="../chapter-keycloak/storage.html">
            
                    
                    Storage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../chapter-keycloak/protocol.html">
            
                <a href="../chapter-keycloak/protocol.html">
            
                    
                    Protocol
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    Deployment
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../chapter-deploy/Introduction.html">
            
                <a href="../chapter-deploy/Introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../chapter-deploy/Docker.html">
            
                <a href="../chapter-deploy/Docker.html">
            
                    
                    Docker
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../chapter-deploy/Kubernetes.html">
            
                <a href="../chapter-deploy/Kubernetes.html">
            
                    
                    Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../chapter-deploy/Systemd_In_Kubernetes.html">
            
                <a href="../chapter-deploy/Systemd_In_Kubernetes.html">
            
                    
                    Systemd In Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../chapter-deploy/Ansible.html">
            
                <a href="../chapter-deploy/Ansible.html">
            
                    
                    Ansible
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../chapter-deploy/Configs.html">
            
                <a href="../chapter-deploy/Configs.html">
            
                    
                    Configurations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../chapter-deploy/Telepresence.html">
            
                <a href="../chapter-deploy/Telepresence.html">
            
                    
                    Telepresence
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    Go Development
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="guideline.html">
            
                <a href="guideline.html">
            
                    
                    Guidelines
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="structure.html">
            
                <a href="structure.html">
            
                    
                    Repository Structure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="testing.html">
            
                <a href="testing.html">
            
                    
                    Testing with mocks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="logging.html">
            
                <a href="logging.html">
            
                    
                    Logging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="instrumenting.html">
            
                <a href="instrumenting.html">
            
                    
                    Instrumenting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="tracing.html">
            
                <a href="tracing.html">
            
                    
                    Tracing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="tracking.html">
            
                <a href="tracking.html">
            
                    
                    Tracking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8" data-path="health_route.html">
            
                <a href="health_route.html">
            
                    
                    Health routes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9" data-path="debugging.html">
            
                <a href="debugging.html">
            
                    
                    Debugging
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4.10" data-path="middleware.html">
            
                <a href="middleware.html">
            
                    
                    Middlewares
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Middlewares</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="middlewares">Middlewares</h1>
<p>The go microservices are built with go-kit and structured in 4 layers:</p>
<ul>
<li>transport</li>
<li>endpoint</li>
<li>component</li>
<li>module</li>
</ul>
<p>Each of these layer can contain middlewares. A typical Cloudtrust microservice will have at least logging, tracing, metric and error tracking middleware. Each of the middleware may be present 0 or more time per layer. For example in the <a href="https://github.com/cloudtrust/flaki-service" target="_blank">flaki-service</a>, there is a metric middleware at the endpoint, component and module level. This middleware tracks the response time of each level, so if there is performance issues or surprisingly slow response from the application, we can quickly pinpoint the source of the problem.</p>
<p>As it is common with go-kit microservices, the components are wired up in the main function. This is why Make...Middleware returns a function with the signature <code>func(endpoint) endpoint</code>. 
For a middleware at transport level the signature will be <code>func(grpc.Handler) grpc.Handler</code> for gRPC, and <code>func(http.Handler) http.Handler</code>for HTTP.
For middleware at component and module level, the signature is <code>func(next Service) Service</code>, where Service is the interface that the service implements.</p>
<p>Below, there is an example of the middlewares at endpoint level.</p>
<h2 id="logging">Logging</h2>
<p>The logging middleware uses a go-kit JSON logger to log events. The logger is previously initialised with predefined key/value in the main function, i.e. <code>MakeLoggingMiddleware(log.With(logger, &quot;time&quot;, log.DefaultTimestampUTC, &quot;caller&quot;, log.DefaultCaller &quot;middleware&quot;, &quot;endpoint&quot;, &quot;service&quot;, &lt;service name&gt;)</code>.
Each call to log will log the previously defined key/values, as well as the new ones: correlation_id and took.</p>
<pre><code class="lang-go"><span class="hljs-comment">// MakeLoggingMiddleware makes a logging middleware.</span>
<span class="hljs-keyword">func</span> MakeLoggingMiddleware(logger log.Logger) endpoint.Middleware {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">func</span>(next endpoint.Endpoint) endpoint.Endpoint {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">func</span>(ctx context.Context, req <span class="hljs-keyword">interface</span>{}) (<span class="hljs-keyword">interface</span>{}, error) {
            <span class="hljs-keyword">defer</span> <span class="hljs-keyword">func</span>(begin time.Time) {
                logger.Log(<span class="hljs-string">&quot;correlation_id&quot;</span>, ctx.Value(<span class="hljs-string">&quot;correlation_id&quot;</span>).(<span class="hljs-keyword">string</span>), <span class="hljs-string">&quot;took&quot;</span>, time.Since(begin))
            }(time.Now())
            <span class="hljs-keyword">return</span> next(ctx, req)
        }
    }
}
</code></pre>
<h2 id="metrics">Metrics</h2>
<p>The metric middleware tracks the duration of the operations at the different levels. The results are saved in an Influx DB time series database.</p>
<pre><code class="lang-go"><span class="hljs-comment">// MakeMetricMiddleware makes a middleware that measure the endpoints response time and</span>
<span class="hljs-comment">// send the metrics to influx DB.</span>
<span class="hljs-keyword">func</span> MakeMetricMiddleware(h metrics.Histogram) endpoint.Middleware {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">func</span>(next endpoint.Endpoint) endpoint.Endpoint {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">func</span>(ctx context.Context, req <span class="hljs-keyword">interface</span>{}) (<span class="hljs-keyword">interface</span>{}, error) {
            <span class="hljs-keyword">defer</span> <span class="hljs-keyword">func</span>(begin time.Time) {
                h.With(<span class="hljs-string">&quot;correlation_id&quot;</span>, ctx.Value(<span class="hljs-string">&quot;correlation_id&quot;</span>).(<span class="hljs-keyword">string</span>)).Observe(time.Since(begin).Seconds())
            }(time.Now())
            <span class="hljs-keyword">return</span> next(ctx, req)
        }
    }
}
</code></pre>
<h2 id="tracing">Tracing</h2>
<p>The tracing middleware helps instrumenting the application by making traces. With them we can follow all request, subrequest between microservices.</p>
<pre><code class="lang-go"><span class="hljs-comment">// MakeTracingMiddleware makes a middleware that handle the tracing with jaeger.</span>
<span class="hljs-keyword">func</span> MakeTracingMiddleware(tracer opentracing.Tracer, operationName <span class="hljs-keyword">string</span>) endpoint.Middleware {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">func</span>(next endpoint.Endpoint) endpoint.Endpoint {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">func</span>(ctx context.Context, request <span class="hljs-keyword">interface</span>{}) (<span class="hljs-keyword">interface</span>{}, error) {
            <span class="hljs-keyword">if</span> span := opentracing.SpanFromContext(ctx); span != <span class="hljs-literal">nil</span> {
                span = tracer.StartSpan(operationName, opentracing.ChildOf(span.Context()))
                <span class="hljs-keyword">defer</span> span.Finish()

                span.SetTag(<span class="hljs-string">&quot;correlation_id&quot;</span>, ctx.Value(<span class="hljs-string">&quot;correlation_id&quot;</span>).(<span class="hljs-keyword">string</span>))

                ctx = opentracing.ContextWithSpan(ctx, span)
            }
            <span class="hljs-keyword">return</span> next(ctx, request)
        }
    }
}
</code></pre>
<h2 id="error-tracking">Error tracking</h2>
<p>The error tracking middleware collects errors and send them to Sentry, where there is a dashboard where we can visualise the errors in real-time.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="debugging.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: Debugging">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Middlewares","level":"1.4.10","depth":2,"previous":{"title":"Debugging","level":"1.4.9","depth":2,"path":"chapter-godevel/debugging.md","ref":"chapter-godevel/debugging.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["richquotes"],"pluginsConfig":{"richquotes":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"chapter-godevel/middleware.md","mtime":"2018-02-23T07:19:38.484Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-04-03T13:03:13.889Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

